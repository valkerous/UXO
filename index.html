<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ultimate Tic-Tac-Toe</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #111;
      color: #fff;
      font-family: sans-serif;
      flex-direction: column;
    }
    .board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 4px;
      border: 4px solid #fff;
      background: #444;
    }
    .small-board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 2px;
      border: 2px solid #fff;
      background: #222;
      width: 150px;
      height: 150px;
    }
    .cell {
      background: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      cursor: pointer;
      color: #ff66cc;
    }
    .cell.taken {
      cursor: not-allowed;
    }
    .cell.highlight {
      box-shadow: inset 0 0 0 3px white;
    }
    #status {
      margin: 15px;
      font-size: 20px;
    }
    #controls {
      margin: 10px;
    }
    button {
      background: #ff66cc;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      color: white;
      margin: 0 5px;
    }
    button:hover {
      background: #ff3399;
    }
  </style>
</head>
<body>
  <div id="status">Player X's turn</div>
  <div id="controls">
    <button id="undoBtn">⏪ Undo</button>
  </div>
  <div class="board" id="bigBoard"></div>
  
  <script>
    const bigBoard = document.getElementById("bigBoard");
    const status = document.getElementById("status");
    const undoBtn = document.getElementById("undoBtn");

    let currentPlayer = "X";
    let activeBoard = null;
    let bigState = Array(9).fill(null);
    let history = []; // để lưu trạng thái cho undo

    function saveState() {
      const snapshot = {
        currentPlayer,
        activeBoard,
        bigState: [...bigState],
        cells: Array.from(document.querySelectorAll(".cell")).map(c => c.textContent),
        boardColors: Array.from(document.querySelectorAll(".small-board")).map(b => b.style.background)
      };
      history.push(snapshot);
    }

    function restoreState() {
      if (history.length === 0) return;
      const snapshot = history.pop();

      currentPlayer = snapshot.currentPlayer;
      activeBoard = snapshot.activeBoard;
      bigState = [...snapshot.bigState];

      const cells = document.querySelectorAll(".cell");
      snapshot.cells.forEach((val, i) => {
        cells[i].textContent = val;
        if (val) cells[i].classList.add("taken");
        else cells[i].classList.remove("taken");
      });

      const boards = document.querySelectorAll(".small-board");
      snapshot.boardColors.forEach((col, i) => {
        boards[i].style.background = col;
      });

      status.textContent = `Player ${currentPlayer}'s turn`;
      updateHighlights();
    }

    function createBoard(boardIndex) {
      const board = document.createElement("div");
      board.classList.add("small-board");
      board.dataset.index = boardIndex;

      for (let i = 0; i < 9; i++) {
        const cell = document.createElement("div");
        cell.classList.add("cell");
        cell.dataset.index = i;
        cell.addEventListener("click", () => handleMove(boardIndex, i, cell));
        board.appendChild(cell);
      }

      return board;
    }

    function checkWinner(cells) {
      const wins = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      for (let combo of wins) {
        const [a,b,c] = combo;
        if (cells[a] && cells[a] === cells[b] && cells[a] === cells[c]) {
          return cells[a];
        }
      }
      return null;
    }

    function isBoardFull(boardEl) {
      return Array.from(boardEl.children).every(c => c.textContent !== "");
    }

    function updateHighlights() {
      document.querySelectorAll(".cell").forEach(c => c.classList.remove("highlight"));

      if (activeBoard !== null) {
        const boardEl = document.querySelector(`.small-board[data-index='${activeBoard}']`);
        if (boardEl && !bigState[activeBoard] && !isBoardFull(boardEl)) {
          Array.from(boardEl.children).forEach(c => {
            if (c.textContent === "") c.classList.add("highlight");
          });
          return;
        }
        activeBoard = null;
      }

      document.querySelectorAll(".small-board").forEach((b, i) => {
        if (!bigState[i] && !isBoardFull(b)) {
          Array.from(b.children).forEach(c => {
            if (c.textContent === "") c.classList.add("highlight");
          });
        }
      });
    }

    function handleMove(boardIndex, cellIndex, cellEl) {
      if (cellEl.textContent !== "" || (activeBoard !== null && activeBoard !== boardIndex)) return;

      saveState(); // lưu trước khi đánh

      cellEl.textContent = currentPlayer;
      cellEl.classList.add("taken");

      const boardEl = document.querySelector(`.small-board[data-index='${boardIndex}']`);
      const cellVals = Array.from(boardEl.children).map(c => c.textContent);
      const winner = checkWinner(cellVals);

      if (winner && !bigState[boardIndex]) {
        bigState[boardIndex] = winner;
        boardEl.style.background = winner === "X" ? "#ff0066" : "#00ccff";
      }

      const bigWinner = checkWinner(bigState);
      if (bigWinner) {
        status.textContent = `Player ${bigWinner} wins the game!`;
        document.querySelectorAll(".cell").forEach(c => c.classList.add("taken"));
        return;
      }

      activeBoard = cellIndex;
      const nextBoardEl = document.querySelector(`.small-board[data-index='${activeBoard}']`);
      if (!nextBoardEl || bigState[activeBoard] || isBoardFull(nextBoardEl)) {
        activeBoard = null;
      }

      currentPlayer = currentPlayer === "X" ? "O" : "X";
      status.textContent = `Player ${currentPlayer}'s turn`;
      updateHighlights();
    }

    // tạo big board
    for (let i = 0; i < 9; i++) {
      bigBoard.appendChild(createBoard(i));
    }

    updateHighlights();

    // gắn sự kiện cho undo
    undoBtn.addEventListener("click", restoreState);
  </script>
</body>
</html>
